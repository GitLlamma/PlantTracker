<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:PlantTracker.ViewModels"
             xmlns:conv="clr-namespace:PlantTracker.Converters"
             x:Class="PlantTracker.Views.MyGardenPage"
             x:DataType="vm:MyGardenViewModel"
             Title="{Binding Title}">

    <ContentPage.Background>
        <SolidColorBrush Color="{AppThemeBinding Light={StaticResource SkyBlueLight}, Dark={StaticResource SkyBlueDark}}"/>
    </ContentPage.Background>

    <ContentPage.Resources>
        <conv:IsNotNullConverter x:Key="IsNotNullConverter"/>
        <conv:IsNullConverter x:Key="IsNullConverter"/>
    </ContentPage.Resources>

    <Grid RowDefinitions="*">

        <!-- Empty state -->
        <VerticalStackLayout IsVisible="{Binding IsEmpty}"
                             VerticalOptions="Center"
                             HorizontalOptions="Center"
                             Spacing="12">
            <Label Text="ðŸª´" FontSize="64" HorizontalOptions="Center"/>
            <Label Text="Your garden is empty." FontSize="18" TextColor="Gray" HorizontalOptions="Center"/>
            <Label Text="Search for plants, or tap + to add a custom one." FontSize="14" TextColor="Gray" HorizontalOptions="Center"/>
        </VerticalStackLayout>

        <!-- Far cloud layer â€” slowest parallax, behind everything -->
        <Image x:Name="CloudsFar"
               Source="clouds_far.svg"
               Aspect="AspectFill"
               HeightRequest="280"
               VerticalOptions="Start"
               InputTransparent="True"
               IsVisible="{Binding IsNotBusy}"/>

        <!-- Near cloud layer â€” medium parallax, in front of far clouds -->
        <Image x:Name="CloudsNear"
               Source="clouds_near.svg"
               Aspect="AspectFill"
               HeightRequest="280"
               VerticalOptions="Start"
               InputTransparent="True"
               IsVisible="{Binding IsNotBusy}"/>

        <!-- Back grass blades â€” declared before CollectionView so they sit behind it -->
        <Image Source="grass_front.svg"
               Aspect="AspectFill"
               HeightRequest="120"
               VerticalOptions="End"
               InputTransparent="True"/>

        <!-- Plant list â€” scrolls over the back grass; footer spacer lets last card clear the front grass -->
        <CollectionView ItemsSource="{Binding Plants}"
                        IsVisible="{Binding IsNotBusy}"
                        SelectionMode="None"
                        Scrolled="OnGardenScrolled">
            <CollectionView.Footer>
                <!-- Matches the height of the front grass overlay so the last card
                     scrolls fully above it before the list ends -->
                <BoxView HeightRequest="120" Color="{AppThemeBinding Light={StaticResource SkyBlueLight}, Dark={StaticResource SkyBlueDark}}"/>
            </CollectionView.Footer>
            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="vm:GardenPlantItem">
                    <Border Style="{StaticResource CardFrame}" Margin="16,6">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer
                                Command="{Binding Source={RelativeSource AncestorType={x:Type vm:MyGardenViewModel}}, Path=GoToPlantDetailCommand}"
                                CommandParameter="{Binding .}"/>
                        </Border.GestureRecognizers>

                        <Grid RowDefinitions="Auto,Auto" RowSpacing="10">

                            <!-- Top row: thumbnail + name + watering info -->
                            <Grid Grid.Row="0" ColumnDefinitions="72,*" ColumnSpacing="12">

                                <!-- Thumbnail -->
                                <Border Grid.Column="0"
                                        StrokeShape="RoundRectangle 8"
                                        HeightRequest="72" WidthRequest="72"
                                        BackgroundColor="{StaticResource Secondary}"
                                        Stroke="Transparent">
                                    <Image Source="{Binding Plant.ThumbnailUrl}"
                                           Aspect="AspectFill"
                                           HeightRequest="72" WidthRequest="72"/>
                                </Border>

                                <!-- Info -->
                                <VerticalStackLayout Grid.Column="1" Spacing="3" VerticalOptions="Center">
                                    <!-- Nickname on top when set, otherwise common name -->
                                    <Label Text="{Binding Plant.Nickname}"
                                           FontAttributes="Bold" FontSize="15"
                                           LineBreakMode="TailTruncation"
                                           IsVisible="{Binding Plant.Nickname, Converter={StaticResource IsNotNullConverter}}"/>
                                    <Label Text="{Binding Plant.CommonName}"
                                           FontAttributes="Bold" FontSize="15"
                                           LineBreakMode="TailTruncation"
                                           IsVisible="{Binding Plant.Nickname, Converter={StaticResource IsNullConverter}}"/>
                                    <!-- Scientific name always shown below -->
                                    <Label Text="{Binding Plant.ScientificName}"
                                           FontSize="12" TextColor="Gray" FontAttributes="Italic"
                                           LineBreakMode="TailTruncation"/>
                                    <Label FontSize="11" TextColor="{StaticResource Primary}"
                                           IsVisible="{Binding Plant.LastWateredAt, Converter={StaticResource IsNotNullConverter}}"
                                           Text="{Binding Plant.LastWateredAt, StringFormat='ðŸ’§ Watered {0:MMM d, yyyy}'}"/>
                                    <Label Text="ðŸ’§ Not yet watered" FontSize="11" TextColor="Gray"
                                           IsVisible="{Binding Plant.LastWateredAt, Converter={StaticResource IsNullConverter}}"/>
                                </VerticalStackLayout>
                            </Grid>

                            <!-- Bottom row: action buttons -->
                            <Grid Grid.Row="1" ColumnDefinitions="*,Auto,Auto" ColumnSpacing="8">
                                <Button Grid.Column="0"
                                        Text="ðŸ’§ Water"
                                        FontSize="13" Padding="0,8"
                                        IsEnabled="{Binding IsWatering, Converter={x:StaticResource InvertedBoolConverter}}"
                                        Command="{Binding Source={RelativeSource AncestorType={x:Type vm:MyGardenViewModel}}, Path=MarkWateredCommand}"
                                        CommandParameter="{Binding .}"/>
                                <Button Grid.Column="1"
                                        Text="ðŸ”•"
                                        FontSize="18" Padding="12,8"
                                        BackgroundColor="{StaticResource Secondary}"
                                        TextColor="{StaticResource Primary}"
                                        Command="{Binding Source={RelativeSource AncestorType={x:Type vm:MyGardenViewModel}}, Path=EditReminderCommand}"
                                        CommandParameter="{Binding .}">
                                    <Button.Triggers>
                                        <DataTrigger TargetType="Button"
                                                     Binding="{Binding ReminderEnabled}"
                                                     Value="True">
                                            <Setter Property="Text" Value="ðŸ””"/>
                                        </DataTrigger>
                                    </Button.Triggers>
                                </Button>
                                <Button Grid.Column="2"
                                        Text="ðŸ—‘"
                                        FontSize="13" Padding="12,8"
                                        BackgroundColor="{StaticResource Gray200}"
                                        TextColor="{StaticResource Gray900}"
                                        Command="{Binding Source={RelativeSource AncestorType={x:Type vm:MyGardenViewModel}}, Path=RemovePlantCommand}"
                                        CommandParameter="{Binding .}"/>
                            </Grid>

                        </Grid>
                    </Border>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>

        <!-- Front grass blades + ground â€” declared after CollectionView so they render on top -->
        <VerticalStackLayout Spacing="0" VerticalOptions="End" InputTransparent="True">
            <Image Source="grass_front.svg"
                   Aspect="AspectFill"
                   HeightRequest="80"/>
            <BoxView HeightRequest="40" Color="#2E7D32"/>
        </VerticalStackLayout>

        <!-- Loading -->
        <ActivityIndicator IsRunning="{Binding IsBusy}"
                           IsVisible="{Binding IsBusy}"
                           VerticalOptions="Center"
                           HorizontalOptions="Center"/>

        <!-- Floating Add Custom Plant button -->
        <Button Text="+"
                Command="{Binding AddCustomPlantCommand}"
                FontSize="28" FontAttributes="Bold"
                WidthRequest="56" HeightRequest="56"
                CornerRadius="28" Padding="0"
                VerticalOptions="End" HorizontalOptions="End"
                Margin="0,0,20,20">
            <Button.Shadow>
                <Shadow Brush="{StaticResource Gray900Brush}" Offset="0,4" Radius="8" Opacity="0.3"/>
            </Button.Shadow>
        </Button>

    </Grid>

</ContentPage>

