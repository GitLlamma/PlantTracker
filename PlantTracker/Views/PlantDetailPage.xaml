<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:PlantTracker.ViewModels"
             x:Class="PlantTracker.Views.PlantDetailPage"
             x:DataType="vm:PlantDetailViewModel"
             Title="{Binding Title}">


    <Grid RowDefinitions="*">

        <ActivityIndicator IsRunning="{Binding IsBusy}"
                           IsVisible="{Binding IsBusy}"
                           VerticalOptions="Center"
                           HorizontalOptions="Center"/>

        <ScrollView IsVisible="{Binding IsNotBusy}">
            <VerticalStackLayout Spacing="0">

                <!-- Hero image -->
                <Image Source="{Binding Detail.ImageUrl}"
                       HeightRequest="220"
                       Aspect="AspectFill"
                       BackgroundColor="{StaticResource Secondary}"/>

                <VerticalStackLayout Padding="20" Spacing="16">

                    <!-- Name + Add to Garden + Edit -->
                    <Grid ColumnDefinitions="*,Auto,Auto" ColumnSpacing="8">
                        <VerticalStackLayout Grid.Column="0" Spacing="4">
                            <!-- Read-only name -->
                            <Label Text="{Binding Detail.CommonName}"
                                   FontSize="22"
                                   FontAttributes="Bold"
                                   IsVisible="{Binding IsEditing, Converter={x:StaticResource InvertedBoolConverter}}"/>
                            <Label Text="{Binding Nickname}"
                                   FontSize="15"
                                   TextColor="{StaticResource Primary}"
                                   FontAttributes="Italic"
                                   IsVisible="{Binding Nickname, Converter={x:StaticResource IsNotNullConverter}}"/>
                            <Label Text="{Binding Detail.ScientificName}"
                                   FontSize="13"
                                   TextColor="Gray"
                                   FontAttributes="Italic"
                                   IsVisible="{Binding IsEditing, Converter={x:StaticResource InvertedBoolConverter}}"/>
                            <!-- Editable name â€” custom plants only -->
                            <Entry Text="{Binding EditCommonName}"
                                   FontSize="20"
                                   FontAttributes="Bold"
                                   Placeholder="Plant name"
                                   IsVisible="{Binding IsEditableCustomPlant}"/>
                            <Entry Text="{Binding EditScientificName}"
                                   FontSize="13"
                                   Placeholder="Scientific name (optional)"
                                   IsVisible="{Binding IsEditableCustomPlant}"/>
                            <!-- Nickname â€” editable for all garden plants -->
                            <Entry Text="{Binding EditNickname}"
                                   FontSize="14"
                                   Placeholder="Nickname (optional)"
                                   IsVisible="{Binding IsEditing}"/>
                        </VerticalStackLayout>
                        <Button Grid.Column="1"
                                Text="+ Garden"
                                Command="{Binding AddToGardenCommand}"
                                IsVisible="{Binding IsInGarden, Converter={x:StaticResource InvertedBoolConverter}}"
                                Style="{StaticResource PrimaryButton}"
                                Padding="10,8"
                                FontSize="13"/>
                        <Label Grid.Column="1"
                               Text="âœ… In Garden"
                               TextColor="{StaticResource Primary}"
                               FontAttributes="Bold"
                               VerticalOptions="Center"
                               IsVisible="{Binding IsInGarden}"/>
                        <Button Grid.Column="2"
                                Text="âœï¸"
                                Command="{Binding BeginEditCommand}"
                                IsVisible="{Binding ShowEditButton}"
                                BackgroundColor="Transparent"
                                TextColor="{StaticResource Primary}"
                                FontSize="20"
                                Padding="4,0"
                                VerticalOptions="Center"/>
                    </Grid>

                    <!-- Planting advice banner -->
                    <Border IsVisible="{Binding Advice, Converter={x:StaticResource IsNotNullConverter}}"
                            BackgroundColor="{StaticResource Secondary}"
                            StrokeShape="RoundRectangle 10"
                            Padding="14,10"
                            Stroke="Transparent">
                        <VerticalStackLayout Spacing="4">
                            <Label Text="{Binding Advice.Message, StringFormat='{0}'}"
                                   FontSize="14"/>
                            <Label Text="{Binding AdviceEmoji, StringFormat='{0} Zone {1}'}"
                                   FontSize="13"
                                   TextColor="{StaticResource Primary}"
                                   FontAttributes="Bold"/>
                        </VerticalStackLayout>
                    </Border>

                    <!-- About / Notes -->
                    <VerticalStackLayout Spacing="6">
                        <Label Text="About" FontAttributes="Bold" FontSize="16"/>
                        <!-- Read-only -->
                        <Label Text="{Binding Detail.Description}"
                               FontSize="14"
                               LineBreakMode="WordWrap"
                               IsVisible="{Binding IsEditing, Converter={x:StaticResource InvertedBoolConverter}}"/>
                        <!-- Editable -->
                        <Border Style="{StaticResource CardFrame}" Padding="12,4"
                                IsVisible="{Binding IsEditing}">
                            <Editor Text="{Binding EditNotes}"
                                    Placeholder="Add notes about this plant..."
                                    AutoSize="TextChanges"
                                    MinimumHeightRequest="80"/>
                        </Border>
                    </VerticalStackLayout>

                    <!-- Care Requirements -->
                    <Label Text="Care Requirements" FontAttributes="Bold" FontSize="16"/>
                    <Grid ColumnDefinitions="*,*" RowDefinitions="Auto,Auto" ColumnSpacing="12" RowSpacing="12">

                        <!-- Watering -->
                        <Border Grid.Row="0" Grid.Column="0" Style="{StaticResource CardFrame}">
                            <VerticalStackLayout Spacing="4">
                                <Label Text="ðŸ’§ Watering" FontSize="12" TextColor="Gray"/>
                                <!-- Read-only -->
                                <Label Text="{Binding Detail.Watering}"
                                       FontAttributes="Bold"
                                       IsVisible="{Binding IsEditing, Converter={x:StaticResource InvertedBoolConverter}}"/>
                                <Label Text="{Binding Detail.WateringFrequencyDays, StringFormat='Every {0} days'}"
                                       FontSize="11" TextColor="Gray"
                                       IsVisible="{Binding Detail.WateringFrequencyDays, Converter={x:StaticResource IsNotNullConverter}}"/>
                                <!-- Editable â€” custom plants only -->
                                <Button Text="{Binding EditSelectedWatering}"
                                        Command="{Binding PickWateringCommand}"
                                        IsVisible="{Binding IsEditableCustomPlant}"
                                        BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray600}}"
                                        TextColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                                        BorderColor="{StaticResource Primary}"
                                        BorderWidth="1"
                                        FontSize="13"
                                        Padding="8,4"
                                        HorizontalOptions="Start"/>
                                <Label Text="{Binding EditWateringDescription}"
                                       FontSize="11" TextColor="Gray"
                                       IsVisible="{Binding IsEditableCustomPlant}"/>
                            </VerticalStackLayout>
                        </Border>

                        <!-- Sunlight -->
                        <Border Grid.Row="0" Grid.Column="1" Style="{StaticResource CardFrame}">
                            <VerticalStackLayout Spacing="4">
                                <Label Text="â˜€ï¸ Sunlight" FontSize="12" TextColor="Gray"/>
                                <!-- Read-only -->
                                <VerticalStackLayout Spacing="3"
                                                     BindableLayout.ItemsSource="{Binding SunlightDescriptions}"
                                                     IsVisible="{Binding IsEditing, Converter={x:StaticResource InvertedBoolConverter}}">
                                    <BindableLayout.ItemTemplate>
                                        <DataTemplate x:DataType="x:String">
                                            <Label Text="{Binding .}" FontSize="12" LineBreakMode="WordWrap"/>
                                        </DataTemplate>
                                    </BindableLayout.ItemTemplate>
                                </VerticalStackLayout>
                                <!-- Editable â€” custom plants only -->
                                <Button Text="{Binding EditSelectedSunlight}"
                                        Command="{Binding PickSunlightCommand}"
                                        IsVisible="{Binding IsEditableCustomPlant}"
                                        BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray600}}"
                                        TextColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                                        BorderColor="{StaticResource Primary}"
                                        BorderWidth="1"
                                        FontSize="13"
                                        Padding="8,4"
                                        HorizontalOptions="Start"/>
                                <Label Text="{Binding EditSunlightDescription}"
                                       FontSize="11" TextColor="Gray"
                                       IsVisible="{Binding IsEditableCustomPlant}"/>
                            </VerticalStackLayout>
                        </Border>

                        <!-- Cycle -->
                        <Border Grid.Row="1" Grid.Column="0" Style="{StaticResource CardFrame}">
                            <VerticalStackLayout Spacing="4">
                                <Label Text="ðŸŒ± Cycle" FontSize="12" TextColor="Gray"/>
                                <!-- Read-only -->
                                <Label Text="{Binding Detail.Cycle}"
                                       FontAttributes="Bold"
                                       IsVisible="{Binding IsEditing, Converter={x:StaticResource InvertedBoolConverter}}"/>
                                <!-- Editable â€” custom plants only -->
                                <Button Text="{Binding EditSelectedCycle}"
                                        Command="{Binding PickCycleCommand}"
                                        IsVisible="{Binding IsEditableCustomPlant}"
                                        BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray600}}"
                                        TextColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                                        BorderColor="{StaticResource Primary}"
                                        BorderWidth="1"
                                        FontSize="13"
                                        Padding="8,4"
                                        HorizontalOptions="Start"/>
                                <Label Text="{Binding EditCycleDescription}"
                                       FontSize="11" TextColor="Gray"
                                       IsVisible="{Binding IsEditableCustomPlant}"/>
                            </VerticalStackLayout>
                        </Border>

                        <!-- Care Level -->
                        <Border Grid.Row="1" Grid.Column="1" Style="{StaticResource CardFrame}">
                            <VerticalStackLayout Spacing="4">
                                <Label Text="ðŸŽ¯ Care Level" FontSize="12" TextColor="Gray"/>
                                <!-- Read-only -->
                                <Label Text="{Binding Detail.CareLevel}"
                                       FontAttributes="Bold"
                                       IsVisible="{Binding IsEditing, Converter={x:StaticResource InvertedBoolConverter}}"/>
                                <!-- Editable â€” custom plants only -->
                                <Button Text="{Binding EditSelectedCareLevel}"
                                        Command="{Binding PickCareLevelCommand}"
                                        IsVisible="{Binding IsEditableCustomPlant}"
                                        BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray600}}"
                                        TextColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                                        BorderColor="{StaticResource Primary}"
                                        BorderWidth="1"
                                        FontSize="13"
                                        Padding="8,4"
                                        HorizontalOptions="Start"/>
                                <Label Text="{Binding EditCareLevelDescription}"
                                       FontSize="11" TextColor="Gray"
                                       IsVisible="{Binding IsEditableCustomPlant}"/>
                            </VerticalStackLayout>
                        </Border>

                    </Grid>

                    <!-- Planting & Growth -->
                    <Label Text="Planting &amp; Growth" FontAttributes="Bold" FontSize="16"
                           IsVisible="{Binding IsEditing, Converter={x:StaticResource InvertedBoolConverter}}"/>
                    <Grid ColumnDefinitions="*,*" ColumnSpacing="12" RowSpacing="12"
                          IsVisible="{Binding IsEditing, Converter={x:StaticResource InvertedBoolConverter}}">

                        <!-- Indoor / Outdoor -->
                        <Border Grid.Column="0" Style="{StaticResource CardFrame}">
                            <VerticalStackLayout Spacing="2">
                                <Label Text="ðŸ  Where to Plant" FontSize="12" TextColor="Gray"/>
                                <Label Text="{Binding IndoorOutdoorText}" FontAttributes="Bold"/>
                                <Label Text="Can also grow outdoors"
                                       FontSize="11" TextColor="Gray"
                                       IsVisible="{Binding Detail.Indoor}"/>
                            </VerticalStackLayout>
                        </Border>

                        <!-- Growth Rate -->
                        <Border Grid.Column="1" Style="{StaticResource CardFrame}"
                                IsVisible="{Binding Detail.GrowthRate, Converter={x:StaticResource IsNotNullConverter}}">
                            <VerticalStackLayout Spacing="4">
                                <Label Text="ðŸ“ˆ Growth Rate" FontSize="12" TextColor="Gray"/>
                                <Label Text="{Binding Detail.GrowthRate}" FontAttributes="Bold"/>
                                <Label Text="{Binding GrowthRateDetail}"
                                       FontSize="12"
                                       LineBreakMode="WordWrap"
                                       IsVisible="{Binding GrowthRateDetail, Converter={x:StaticResource IsNotNullConverter}}"/>
                            </VerticalStackLayout>
                        </Border>

                    </Grid>

                    <!-- Hardiness zones -->
                    <Border Style="{StaticResource CardFrame}"
                            IsVisible="{Binding Detail.HardinessZoneMin, Converter={x:StaticResource IsNotNullConverter}}">
                        <HorizontalStackLayout Spacing="8">
                            <Label Text="ðŸ—ºï¸ Hardiness Zones:" FontAttributes="Bold" VerticalOptions="Center"/>
                            <Label Text="{Binding Detail.HardinessZoneMin}" VerticalOptions="Center"/>
                            <Label Text="â€“" VerticalOptions="Center"/>
                            <Label Text="{Binding Detail.HardinessZoneMax}" VerticalOptions="Center"/>
                        </HorizontalStackLayout>
                    </Border>

                    <!-- Diseases & Pests -->
                    <Button Text="ðŸ¦  View Diseases &amp; Pests"
                            Command="{Binding GoToDiseasesCommand}"
                            IsVisible="{Binding HasPerenualData}"
                            Style="{StaticResource PrimaryButton}"
                            Margin="0,8,0,0"/>

                    <!-- My Photos gallery -->
                    <Button Text="ðŸ“· My Photos"
                            Command="{Binding GoToGalleryCommand}"
                            IsVisible="{Binding IsInGardenAndSaved}"
                            Style="{StaticResource PrimaryButton}"
                            Margin="0,4,0,0"/>

                    <!-- Save / Cancel bar â€” visible while editing -->
                    <Grid ColumnDefinitions="*,*" ColumnSpacing="12"
                          IsVisible="{Binding IsEditing}"
                          Margin="0,8,0,0">
                        <Button Grid.Column="0"
                                Text="Cancel"
                                Command="{Binding CancelEditCommand}"
                                BackgroundColor="{StaticResource Gray200}"
                                TextColor="{StaticResource Gray900}"/>
                        <Button Grid.Column="1"
                                Text="Save Changes âœ…"
                                Command="{Binding SaveEditCommand}"
                                Style="{StaticResource PrimaryButton}"
                                IsEnabled="{Binding IsBusy, Converter={StaticResource InvertedBoolConverter}}"/>
                    </Grid>


                </VerticalStackLayout>
            </VerticalStackLayout>
        </ScrollView>

    </Grid>
</ContentPage>

